<template>
  <view class="diary-detail-page" :class="themeStore.currentThemeClass">
    <!-- 头部导航 -->
    <view class="detail-header">
      <view class="back-btn" @tap="handleBack">
        <!-- <text class="icon">←</text> -->
        <text>返回</text>
      </view>
      <text class="detail-title">日记详情</text>
      <view class="header-actions">
        <text class="icon">⋮</text>
      </view>
    </view>

    <!-- 加载状态 -->
    <view v-if="loading" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>

    <!-- 错误状态 -->
    <view v-else-if="error" class="error-container">
      <view class="error-icon">😞</view>
      <text class="error-text">{{ error }}</text>
      <view class="error-actions">
        <view class="retry-btn" @tap="loadDiaryDetail(diaryId)">重试</view>
        <view class="back-btn-error" @tap="handleBack">返回</view>
      </view>
    </view>

    <!-- 日记内容区域 -->
    <scroll-view v-else class="detail-content" scroll-y>
      <!-- 日记标题 -->
      <view class="diary-title-section">
        <text class="diary-title">{{
          diaryDetail?.diary?.title || "无标题"
        }}</text>
        <!-- 权限和统计信息 -->
        <view class="diary-meta">
          <view class="meta-item">
            <text class="permission-icon">{{
              getPermissionIcon(permission)
            }}</text>
            <text class="permission-text">{{
              getPermissionText(permission)
            }}</text>
          </view>
          <view class="meta-item">
            <text class="stat-icon">👁️</text>
            <text class="stat-text">{{ formatPageview(pageviewCount) }}</text>
          </view>
          <view class="meta-item">
            <text class="stat-icon">❤️</text>
            <text class="stat-text">{{ formatLikeCount(likeCount) }}</text>
          </view>
        </view>
      </view>

      <!-- 作者信息 -->
      <view class="author-section">
        <view class="author-info">
          <text class="author-name-large">{{ authorName }}</text>
          <text class="publish-time">发布于 {{ publishTime }}</text>
        </view>
      </view>

      <!-- 标签区域 -->
      <view v-if="tags.length > 0" class="tags-section">
        <view class="tag-item" v-for="tag in tags" :key="tag.id">
          <text class="tag-text">{{ tag.displayText }}</text>
        </view>
      </view>

      <!-- 日记内容 -->
      <view class="diary-content">
        <text class="content-text">{{ diaryContent }}</text>
      </view>

      <!-- 互动按钮 -->
      <view class="interaction-buttons">
        <view class="interaction-btn" @tap="handleLike">
          <text class="icon">{{ isLiked ? "❤️" : "🤍" }}</text>
          <text class="btn-text">{{ formatLikeCount(likeCount) }}</text>
        </view>
        <view class="interaction-btn" @tap="handleComment">
          <text class="icon">💬</text>
          <text class="btn-text">{{ commentCount }}</text>
        </view>
        <view class="interaction-btn" @tap="handleShare">
          <text class="icon">↗️</text>
          <text class="btn-text">分享</text>
        </view>
      </view>

      <!-- 评论列表 -->
      <view class="comments-section">
        <text class="section-title">评论 ({{ comments.length }})</text>

        <view class="comment-list">
          <view
            v-for="comment in comments"
            :key="comment.id"
            class="comment-item"
          >
            <view class="comment-content">
              <view class="comment-header">
                <text class="comment-author">{{ comment.author }}</text>
                <text class="comment-time">{{ comment.time }}</text>
              </view>
              <text class="comment-text">{{ comment.content }}</text>
              <view class="comment-actions">
                <text class="action-btn" @tap="handleReply(comment)">回复</text>
                <text class="action-btn" @tap="handleLikeComment(comment)">
                  {{ comment.liked ? "❤️" : "🤍" }} {{ comment.likes }}
                </text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- 底部评论输入框 -->
    <view class="comment-input-container">
      <input
        class="comment-input"
        placeholder="写下你的评论..."
        :value="commentText"
        @input="onCommentInput"
        @confirm="handleSendComment"
      />
      <view class="send-btn" @tap="handleSendComment">
        <text>发送</text>
      </view>
    </view>
  </view>
</template>

<script setup>
import { ref, onMounted } from "vue";
import Taro from "@tarojs/taro";
import { useThemeStore } from "../../../stores/theme";
import diaryAPI from "../../../utils/diary";
import {
  formatPublishTime,
  getPermissionText,
  getPermissionIcon,
  formatTags,
  formatPageview,
  formatLikeCount,
  processContent,
  getDefaultAuthorName,
  validateDiaryDetail,
} from "../../../utils/detail";

const themeStore = useThemeStore();

// 页面状态
const loading = ref(true);
const error = ref("");

// 日记数据
const diaryId = ref("");
const diaryDetail = ref(null);
const diaryContent = ref("");
const publishTime = ref("");
const isLiked = ref(false);
const likeCount = ref(0);
const pageviewCount = ref(0);
const commentCount = ref(0);
const authorName = ref("");
const tags = ref([]);
const permission = ref(null);

// 评论数据
const comments = ref([
  {
    id: 1,
    author: "小红",
    content: "这句话真的很有道理，值得深思！",
    time: "2小时前",
    likes: 3,
    liked: false,
  },
  {
    id: 2,
    author: "小刚",
    content: "歌德的智慧总是能给人启发",
    time: "1小时前",
    likes: 1,
    liked: true,
  },
]);

const commentText = ref("");

// 使用 onMounted 替代 onLoad
onMounted(() => {
  // 在 Taro 中，可以通过 getCurrentInstance 获取路由参数
  const currentInstance = Taro.getCurrentInstance();
  const options = currentInstance.router?.params || {};

  console.log("详情页加载，参数:", options);
  console.log("日记ID:", options.id);

  diaryId.value = options.id;
  loadDiaryDetail(options.id);
});

const loadDiaryDetail = async (id) => {
  if (!id) {
    error.value = "缺少日记ID参数";
    loading.value = false;
    Taro.showModal({
      title: "参数错误",
      content: "缺少日记ID参数",
      showCancel: false,
      success: () => {
        Taro.navigateBack();
      },
    });
    return;
  }

  try {
    loading.value = true;
    error.value = "";

    console.log("🟢 开始加载日记详情，ID:", id);

    // 调用API获取日记详情
    const response = await diaryAPI.getDiaryDetail(id);

    console.log("✅ 获取日记详情成功:", response);

    // 验证数据结构
    if (!validateDiaryDetail(response)) {
      throw new Error("日记详情数据格式不正确");
    }

    // 设置数据
    diaryDetail.value = response;
    const diary = response.diary;

    // 基础信息
    diaryContent.value = processContent(diary.content);
    publishTime.value = formatPublishTime(diary.created_at);
    isLiked.value = response.is_liked || false;
    likeCount.value = diary.like || 0;
    pageviewCount.value = diary.pageview || 0;
    authorName.value = getDefaultAuthorName(); // 暂时使用默认名称

    // 标签信息
    tags.value = formatTags(response.tags || []);

    // 权限信息
    permission.value = response.permission;

    // 评论数量（暂时使用静态数据，后续可扩展）
    commentCount.value = 0;

    console.log("✅ 日记详情数据设置完成");
  } catch (err) {
    console.error("❌ 加载日记详情失败:", err);
    error.value = err.message || "加载日记详情失败";

    Taro.showModal({
      title: "加载失败",
      content: error.value,
      showCancel: true,
      cancelText: "返回",
      confirmText: "重试",
      success: (res) => {
        if (res.confirm) {
          loadDiaryDetail(id);
        } else {
          Taro.navigateBack();
        }
      },
    });
  } finally {
    loading.value = false;
  }
};

const handleBack = () => {
  Taro.navigateBack();
};

const handleLike = () => {
  isLiked.value = !isLiked.value;
  likeCount.value += isLiked.value ? 1 : -1;
};

const handleComment = () => {
  // 聚焦到输入框
};

const handleShare = () => {
  Taro.showShareMenu({
    withShareTicket: true,
  });
};

const handleReply = (comment) => {
  commentText.value = `@${comment.author} `;
};

const handleLikeComment = (comment) => {
  comment.liked = !comment.liked;
  comment.likes += comment.liked ? 1 : -1;
};

const onCommentInput = (e) => {
  commentText.value = e.detail.value;
};

const handleSendComment = () => {
  if (!commentText.value.trim()) return;

  const newComment = {
    id: Date.now(),
    author: "当前用户",
    content: commentText.value,
    time: "刚刚",
    likes: 0,
    liked: false,
  };

  comments.value.unshift(newComment);
  commentCount.value += 1;
  commentText.value = "";
  Taro.pageScrollTo({
    scrollTop: 0,
    duration: 300,
  });
};
</script>

<style>
@import "./index.scss";
</style>
